.PHONY: help build run stop clean test docker-build docker-run docker-stop docker-clean docker-logs

# VariÃ¡veis
DOCKER_IMAGE_NAME = hackaton-soat-processor
DOCKER_IMAGE_TAG = latest
BINARY_NAME = worker

help: ## Mostra esta mensagem de ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Comandos Go locais
build: ## Compila o binÃ¡rio localmente
	@echo "ğŸ”¨ Compilando binÃ¡rio..."
	go build -o $(BINARY_NAME) cmd/worker/main.go
	@echo "âœ… BinÃ¡rio criado: $(BINARY_NAME)"

run: ## Executa o worker localmente
	@echo "ğŸš€ Executando worker..."
	go run cmd/worker/main.go

test: ## Executa todos os testes
	@echo "ğŸ§ª Executando testes..."
	go test -v ./...

test-cover: ## Executa testes com cobertura
	@echo "ğŸ§ª Executando testes com cobertura..."
	go test -cover ./...
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… RelatÃ³rio de cobertura gerado: coverage.html"

clean: ## Remove binÃ¡rios e arquivos temporÃ¡rios
	@echo "ğŸ§¹ Limpando arquivos..."
	rm -f $(BINARY_NAME)
	rm -f coverage.out coverage.html
	rm -rf temp/
	rm -rf outputs/
	@echo "âœ… Limpeza concluÃ­da"

# Comandos Docker
docker-build: ## ConstrÃ³i a imagem Docker
	@echo "ğŸ³ Construindo imagem Docker..."
	docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG) .
	@echo "âœ… Imagem construÃ­da: $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG)"

docker-run: ## Executa o container Docker
	@echo "ğŸ³ Iniciando container..."
	docker-compose up -d
	@echo "âœ… Container iniciado"

docker-stop: ## Para o container Docker
	@echo "ğŸ›‘ Parando container..."
	docker-compose down
	@echo "âœ… Container parado"

docker-logs: ## Mostra os logs do container
	docker-compose logs -f worker

docker-clean: ## Remove imagens e containers Docker
	@echo "ğŸ§¹ Limpando Docker..."
	docker-compose down -v
	docker rmi $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG) 2>/dev/null || true
	@echo "âœ… Limps3://teste-video-processor/processed/frames_f0f0dbb2-197c-4be0-b020-2caa043bba33.zipeza Docker concluÃ­da"

docker-shell: ## Abre um shell no container
	docker-compose exec worker /bin/sh

docker-rebuild: docker-clean docker-build ## ReconstrÃ³i a imagem do zero

# Comandos de desenvolvimento
dev: ## Inicia o ambiente de desenvolvimento
	@echo "ğŸ”§ Iniciando ambiente de desenvolvimento..."
	docker-compose up --build

deps: ## Baixa as dependÃªncias do Go
	@echo "ğŸ“¦ Baixando dependÃªncias..."
	go mod download
	go mod tidy
	@echo "âœ… DependÃªncias atualizadas"

fmt: ## Formata o cÃ³digo Go
	@echo "âœ¨ Formatando cÃ³digo..."
	go fmt ./...
	@echo "âœ… CÃ³digo formatado"

lint: ## Executa o linter
	@echo "ğŸ” Executando linter..."
	golangci-lint run ./... || echo "âš ï¸  Instale golangci-lint: https://golangci-lint.run/usage/install/"

# Comandos de deploy
docker-push: ## Faz push da imagem para o registry
	@echo "ğŸ“¤ Enviando imagem para registry..."
	docker push $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG)
	@echo "âœ… Imagem enviada"

docker-tag: ## Cria uma tag para a imagem
	@read -p "Digite a versÃ£o (ex: v1.0.0): " version; \
	docker tag $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG) $(DOCKER_IMAGE_NAME):$$version
	@echo "âœ… Tag criada"

# Info
info: ## Mostra informaÃ§Ãµes do projeto
	@echo "ğŸ“Š InformaÃ§Ãµes do Projeto"
	@echo "------------------------"
	@echo "Imagem Docker: $(DOCKER_IMAGE_NAME):$(DOCKER_IMAGE_TAG)"
	@echo "BinÃ¡rio: $(BINARY_NAME)"
	@echo ""
	@echo "VersÃ£o Go:"
	@go version
	@echo ""
	@echo "DependÃªncias:"
	@go list -m all | head -5
